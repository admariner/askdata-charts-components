<!--
    THIS EXAMPLE WAS DOWNLOADED FROM https://echarts.apache.org/examples/en/editor.html?c=funnel
-->
<!DOCTYPE html>
<html style="height: 100%">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>
        <script src="/lib/scripts/utils.js"></script>
        <script src="/lib/scripts/env.js"></script>
        <script src="/lib/scripts/jquery.min.js"></script>
        <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
        <link href="/lib/styles/css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" type="text/css" href="/lib/styles/style.css">
        <script src="https://unpkg.com/mustache@latest"></script>
    </head>


    <body style="height: 100%; margin: 0">
        <div id="container" style="height: 100%"></div>
    </body>

    
        <script type="text/javascript">


//environment_widget = "https://api-dev.askdata.com";
// environment_widget = "https://api-qa.askdata.com"
// environment_widget = "https://api.askdata.com"  // prod  da togliere quando porto su...


$.ajax({

url: environment_widget +"/smartinsight/widgets/" + getUrlParameter('widgetId'),
type: "GET",
async: false,
beforeSend: function(xhr){xhr.setRequestHeader('Authorization', 'Bearer ' + getToken() 
 ).setRequestHeader('Content-Type','application/json')},
success: function(data) { 
            console.log(data)      
            

            var dom = document.getElementById("container");
            var myChart = echarts.init(dom);
            var app = {};

            var option;
//  QUI


            // Function to detect the label to show in the graph
            function identify_label(value) {
              labels = ['€', '$', '£', '%'];
              for (let i = 0; i < labels.length; i++) {
                if (value.indexOf(labels[i]) > -1) {
                  return labels[i];
                }
              }
              return '';
            }


            var data_for_bar_race = [];

            var categorie = [];

            for (var i = 0; i < data.fields.m1_id.length; ++i) {
              categorie.push(data.fields.m1_id[i].name);
            }

            var titles = data.fields.s1_id.data;

            try {
              var barcolor = data.fields.s2_id.data;
            } catch (error) {
              console.log("Error", error.name);
              var barcolor = '#0c5a93';
            }

            try {
              var labelcolor = data.fields.s3_id.data;
            } catch (error) {
              console.log("Error", error.name);
              var labelcolor = '#0c5a93';
            }

            try {
              var symbol = identify_label(data.fields.m1_id[0].data);
            } catch (error) {
              console.log("Error", error.name);
              var symbol = '';
            }

            // var symbol = " €"
            // var cats =  ['VOICE', "CAPACITY", 'DATA ROAMING \n & CONNECTIVITY', 'IP TRANSIT', 'MESSAGING', 'NETWORKING\n SOLUTIONS',  "SPARKLE CLOUD", 'LANDING AND\n CONNECTIVITY\n HUB']

            // var voice = [37821154,  46535284, 54203496, 47278433, 52157095, 59164867,47736691, 56165969,  54310078, 66218240, 51052400, 54078044]
            // var datar =[1389089,1336505,1318379,1631587,1480739,1432100,1716844,2188243,959739, 1200884,1862210,1942294]
            // var ip = [8925025,9281221,10827507,10410788,8996464,13033929,8856714,9068195,12615544,9051561,9135366,16571209]
            // var messaging = [2319710, 2077577,  2829129,  2342813,  2771483,  2225890,  2199349,  3196656,3256643,  3860252,  2559835,  2770564]
            // var network = [3956017, 4240659,  4254764,  4216304,  4186877,  4252795,  5112524,  4934827,  4641680,  5045986,  5205126,  6666506]
            // var cloud = [532056,  508636, 571289, 556150, 596716, 670821, 475513, 737815, 639889, 692539, 487800, 765672,]
            // var hub = [934161, 2707308, 1888744, 940142, 1032699, 1864678, 2655509, 1764213, 1093969, 1491784, 4026901, 1942294]
            // var capacity = [8512759, 8663241,     9489589,   8468723, 9330673, 10783493, 9349694, 9195038,   13415540,    9368518, 14850869, 17145107]
            // titles = ["Jan 21", "Feb 21", "Mar 21", "Apr 21", "Mag 21", "Giu 21", "Lug 21", "Ago 21", "Set 21", "Ott 21", "Nov 21", "Dic 21"]

            // number of rows to show. If more than 5 I just show 5
            var bars_to_show = categorie.length;
            if (bars_to_show > 5) {
              bars_to_show = 5;
            }

            // Initial value for all rows is 0
            for (var i = 0; i < categorie.length; ++i) {
              data_for_bar_race.push(0);
            }

            console.log(data_for_bar_race);

            // Support variables
            // First is fort title to be updated
            // Second is just an identifier
            labb = '0';
            var count = 0;

            option = {
              title: { text: labb, left: 'center', top: 10 },
              grid: { left: 130, right: 120 },
              xAxis: {
                max: 'dataMax',

                axisLabel: {
                  show: true,
                  position: 'right',
                  color: labelcolor,
                  formatter: function (d) {
                    return String(d).replace(/(.)(?=(\d{3})+$)/g, '$1,') + symbol;
                  }
                }
              },
              yAxis: {
                type: 'category',
                inverse: true,
                data: categorie,
                axisLabel: {
                  color: labelcolor
                },
                animationDuration: 300,
                animationDurationUpdate: 300,
                max: bars_to_show - 1 // only the largest 5 bars will be displayed
              },
              series: [
                {
                  realtimeSort: true,
                  name: 'X',
                  type: 'bar',
                  data: data_for_bar_race,
                  color: barcolor,
                  label: {
                    show: true,
                    position: 'right',
                    color: labelcolor,
                    formatter: function (d) {
                      return String(d.value.toLocaleString()) + symbol;
                    },
                    valueAnimation: true
                  }
                }
              ],
              legend: {
                show: false
              },
              animationDuration: 0,
              animationDurationUpdate: 3000,
              animationEasing: 'linear',
              animationEasingUpdate: 'linear'
            };

            // Update data and labels
            function run() {
              if (count == titles.length) {
                for (var s = 0; i < data_for_bar_race.length; ++s) {
                  data_for_bar_race[s] = data.fields.m1_id[s].rawData[count - 1];
                }
                labb = titles[count - 1];
              } else {
                for (var i = 0; i < data_for_bar_race.length; ++i) {
                  data_for_bar_race[i] = data.fields.m1_id[i].rawData[count];
                }
                labb = titles[count];
                count = count + 1;
              }

              myChart.setOption({
                series: [
                  {
                    type: 'bar',
                    data_for_bar_race
                  }
                ],
                title: [
                  {
                    text: labb
                  }
                ]
              });

              // console.log(data)
              // console.log(count)
            }
            setTimeout(function () {
              run();
            }, 10);
            setInterval(function () {
              run();
            }, 4000);









// QUI
            if (option && typeof option === 'object') {
                myChart.setOption(option);
            }
    }
  });
        </script>

</html>